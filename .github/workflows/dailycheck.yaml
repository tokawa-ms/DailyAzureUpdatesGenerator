name: Daily Update Check by External Trigger

on:
  # 外部オーケストレーターからの起動のみを受け付ける
  repository_dispatch:
    types: [daily-update]

permissions:
  id-token: write
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Resolve OIDC/auth settings
        shell: bash
        env:
          AZURE_CLIENT_ID_SECRET: ${{ secrets.AZURE_CLIENT_ID }}
          AZURE_TENANT_ID_SECRET: ${{ secrets.AZURE_TENANT_ID }}
          AZURE_SUBSCRIPTION_ID_SECRET: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          AZURE_CLIENT_SECRET_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
          AOAI_ENDPOINT_SECRET: ${{ secrets.AOAI_ENDPOINT }}
          DEPLOYMENT_SECRET: ${{ secrets.DEPLOYMENT }}
          API_VER_SECRET: ${{ secrets.API_VER }}
          CHECK_HOURS_SECRET: ${{ secrets.CHECK_HOURS }}
        run: |
          # OIDC に必要な3要素が揃っている場合は Federated Identity フローを優先
          if [ -n "${AZURE_CLIENT_ID_SECRET}" ] && [ -n "${AZURE_TENANT_ID_SECRET}" ] && [ -n "${AZURE_SUBSCRIPTION_ID_SECRET}" ]; then
            echo "USE_OIDC_FLOW=true" >> "$GITHUB_ENV"
            echo "AZURE_CLIENT_ID=${AZURE_CLIENT_ID_SECRET}" >> "$GITHUB_ENV"
            echo "AZURE_TENANT_ID=${AZURE_TENANT_ID_SECRET}" >> "$GITHUB_ENV"
            echo "AZURE_SUBSCRIPTION_ID=${AZURE_SUBSCRIPTION_ID_SECRET}" >> "$GITHUB_ENV"

            [ -n "${AOAI_ENDPOINT_SECRET}" ] && echo "AOAI_ENDPOINT=${AOAI_ENDPOINT_SECRET}" >> "$GITHUB_ENV"

            [ -n "${DEPLOYMENT_SECRET}" ] && echo "DEPLOYMENT=${DEPLOYMENT_SECRET}" >> "$GITHUB_ENV"
            [ -n "${API_VER_SECRET}" ] && echo "API_VER=${API_VER_SECRET}" >> "$GITHUB_ENV"
            [ -n "${CHECK_HOURS_SECRET}" ] && echo "CHECK_HOURS=${CHECK_HOURS_SECRET}" >> "$GITHUB_ENV"
            exit 0
          fi

          # OIDC が成立しない場合は従来の client secret を使う
          echo "USE_OIDC_FLOW=false" >> "$GITHUB_ENV"
          [ -n "${AZURE_CLIENT_SECRET_SECRET}" ] && echo "AZURE_CLIENT_SECRET=${AZURE_CLIENT_SECRET_SECRET}" >> "$GITHUB_ENV"

      - name: Azure Login (OIDC / Federated Identity)
        if: env.USE_OIDC_FLOW == 'true'
        uses: azure/login@v2
        with:
          client-id: ${{ env.AZURE_CLIENT_ID }}
          tenant-id: ${{ env.AZURE_TENANT_ID }}
          subscription-id: ${{ env.AZURE_SUBSCRIPTION_ID }}

      - name: Setup python
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"
          cache: "pip"

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run Main Script
        env:
          AOAI_ENDPOINT: ${{ env.AOAI_ENDPOINT || secrets.AOAI_ENDPOINT }}
          # AOAI_KEY: ${{ secrets.AOAI_KEY }}
          DEPLOYMENT: ${{ env.DEPLOYMENT || secrets.DEPLOYMENT }}
          API_VER: ${{ env.API_VER || secrets.API_VER }}
          CHECK_HOURS: ${{ env.CHECK_HOURS || secrets.CHECK_HOURS }}
          AZURE_TENANT_ID: ${{ env.AZURE_TENANT_ID || secrets.AZURE_TENANT_ID }}
          AZURE_CLIENT_ID: ${{ env.AZURE_CLIENT_ID || secrets.AZURE_CLIENT_ID }}
          AZURE_SUBSCRIPTION_ID: ${{ env.AZURE_SUBSCRIPTION_ID || secrets.AZURE_SUBSCRIPTION_ID }}
          ACTIONS_ID_TOKEN_REQUEST_URL: ${{ env.ACTIONS_ID_TOKEN_REQUEST_URL }}
          ACTIONS_ID_TOKEN_REQUEST_TOKEN: ${{ env.ACTIONS_ID_TOKEN_REQUEST_TOKEN }}
        run: |
          # 現行運用は mid 版を採用（詳細モード + READMEインデックス更新）
          python getlatestupdate_mid.py --details
          python getlatestupdate_en_mid.py --details
          python generate_readme.py updates
          python generate_readme_en.py updates_en

      - name: Commit and Push
        run: |
          # 生成結果を main に反映
          git config user.name "Takashi Okawa BOT"
          git config user.email "automate@okawa.work"
          git add .
          git commit -m "Daily Azure Updates Commit."
          git pull
          git push origin main
